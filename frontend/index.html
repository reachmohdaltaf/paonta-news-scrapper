<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paonta News Scraper</title>
<link rel="stylesheet" href="index.css">
</head>
<body>

<h1>Latest Paonta Sahib News</h1>
<button id="reload-btn">Reload News</button>
<div id="news-container"></div>
<canvas id="imageCanvas" style="display: none;"></canvas>

<script>
async function fetchNews() {
    const container = document.getElementById('news-container');
    container.innerHTML = 'Loading news...';

    try {
        const res = await fetch('/scrape'); // Relative URL for production
        const data = await res.json();
        container.innerHTML = '';

        if (!data.news || data.news.length === 0) {
            container.textContent = "No news found for today.";
            return;
        }

        data.news.forEach(item => {
            const div = document.createElement('div');
            div.className = 'news-item';

            const a = document.createElement('a');
            a.href = item.url;
            a.target = '_blank';
            a.textContent = item.headline;

            const date = document.createElement('div');
            date.className = 'date';
            date.textContent = new Date(item.date).toLocaleString('hi-IN', {
                day: 'numeric', month: 'long', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });

            const content = document.createElement('p');
            content.textContent = item.content;

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'button-container';

            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'Copy Title';
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(item.headline);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy Title', 1500);
            });

            const makePostBtn = document.createElement('button');
            makePostBtn.textContent = 'Make Post';
            makePostBtn.addEventListener('click', () => generatePostImage(item.headline));

            const aiBtn = document.createElement('button');
            aiBtn.textContent = 'Generate with AI';
            aiBtn.addEventListener('click', () => generateWithAI(item.headline));

            buttonContainer.appendChild(copyBtn);
            buttonContainer.appendChild(makePostBtn);
            buttonContainer.appendChild(aiBtn);

            div.appendChild(a);
            div.appendChild(date);
            div.appendChild(content);
            div.appendChild(buttonContainer);
            container.appendChild(div);
        });
    } catch (err) {
        console.error('Failed to fetch news', err);
        container.textContent = "Failed to load news.";
    }
}

async function generatePostImage(headline) {
    try {
        const response = await fetch('/generate-post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ headline })
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `zafaroo-news-post-${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } else alert('Failed to generate post image');
    } catch (error) {
        console.error('Error generating post:', error);
        alert('Error generating post image');
    }
}

async function generateWithAI(headline) {
    try {
        const response = await fetch('/generate-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ headline })
        });

        if (response.ok) {
            const result = await response.json();
            alert('AI Generated Content:\n' + result.content);
        } else alert('Failed to generate content with AI');
    } catch (error) {
        console.error('AI generation error:', error);
        alert('Error generating content with AI');
    }
}

// Fetch news on page load
fetchNews();
document.getElementById('reload-btn').addEventListener('click', fetchNews);
</script>
</body>
</html>
